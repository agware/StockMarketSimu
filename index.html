<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stock Market Simulation</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
</head>
<body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="logic.js"></script>
<script src="drinks.js"></script>
<script src="stock.js"></script>
<script src="news.js"></script>

<div id="main-container">
    <div id="market-container" class="graph-container"></div>
    <div id="spirits-container" class="graph-container"></div>
    <div id="news-container" class="graph-container"></div>
    <div id="beer-container" class="graph-container"></div>
</div>

<script>
    let stock = rnorm(0,0.1);
    let stocks = [];
    let secondCount = 0;
    let newsVal = 0;
    const maxStocksRecorded = 100;
    for(let i = 0; i < maxStocksRecorded; i++) {
        stocks.push(0);
    }

    initDrinkChart('beer');
    initDrinkChart('spirits');
    initNews();
    initStockGraph(stocks,maxStocksRecorded);

    d3.timer(runSimulation);

    function runSimulation(msElapsed) {
        let secondsElapsed = Math.floor(msElapsed/500)/2;

        // Terminate simulation if max time reached
        const secondsInHour = 360; const hours = 4;
        const maxTime = secondsInHour*hours;
        if(secondsElapsed >= maxTime) { return true;}

        // Update simulation every new second value
        // Currently updating on the half second
        if(secondsElapsed > secondCount) {
            stocks.push(stock);

            // If there are too many stock values recorded, remove the oldest one
            if(stocks.length > maxStocksRecorded) { stocks.shift();}

            // Update stock graph
            updateStockGraph(stocks);

            // Update drinks
            const priceUpdate = 7;
            if(secondsElapsed % priceUpdate < 0.5 || secondsElapsed < 1.5) {
                updateBeer('beer', stock);
                updateSpirits('spirits', stock);
            }


            // Update news?
            const newsUpdate = 4;
            let newsTime = Math.round(newsUpdate - (secondCount-0.5)%newsUpdate - 1);
            d3.select('#news-time').text(newsTime + 's until next update');
            if (secondsElapsed % newsUpdate == 0 || secondsElapsed < 1.5) {
                newsVal = updateNews();
            }

            // Stock calculation
            let mean = calculateMean(stock);
            let vol = calculateVol(secondsElapsed, stocks);
            stock += rnorm(mean, vol);
            if(newsVal < 0) {
                stock -= 0.5;
            } else if(newsVal > 0) {
                stock += 0.5;
            }

            secondCount = secondsElapsed;
        }
    }

</script>

</body>
</html>